--4. Sử dụng ngôn ngữ SQL tạo CSDL, tạo các bảng từ câu 3.

CREATE DATABASE QuanLyNhaThuoc;

CREATE TABLE HANGSX
(
	MAHANGSX varchar(30) PRIMARY KEY,
	QUOCGIA varchar(50) NOT NULL,
	TENHANG varchar(50) NOT NULL
);

CREATE TABLE LOAITHUOC
(
	MALOAI varchar(30) PRIMARY KEY,
	GHICHU varchar(255) NOT NULL,
	TENLOAI varchar(50) NOT NULL,
);

CREATE TABLE NHACC
(
	MANHACC varchar(30) PRIMARY KEY,
	TENNHACC varchar(50) NOT NULL,
	DIACHI varchar(255) NOT NULL,
	TT_DAIDIEN varchar(255) NOT NULL
);

CREATE TABLE THUOC
(
	MATHUOC varchar(30) PRIMARY KEY,
	TENTHUOC varchar(50) NOT NULL,
	CONGDUNG varchar(255) NOT NULL,
	GHICHU varchar(255) NOT NULL,
	MAHANGSX varchar(30),
	FOREIGN KEY (MAHANGSX) REFERENCES HANGSX(MAHANGSX),
	MALOAI varchar(30),
	FOREIGN KEY (MALOAI) REFERENCES LOAITHUOC(MALOAI),
	MANHACC varchar(30),
	FOREIGN KEY(MANHACC) REFERENCES NHACC(MANHACC)
);

CREATE TABLE NHANVIEN
(
	MANV varchar(30) PRIMARY KEY,
	NGAYSINH date NOT NULL,
	HOTEN varchar(50) NOT NULL,
	SDT varchar(50) NOT NULL
);

CREATE TABLE KHACHHANG
(
	MAKH varchar(30) PRIMARY KEY,
	TENKH varchar(50) NOT NULL,
	SDT varchar(50) NOT NULL,
	DIACHI varchar(255) NOT NULL
);

CREATE TABLE PHIEUNHAP
(
	MAPN varchar(30) PRIMARY KEY,
	NGAYNHAP date NOT NULL,
	MANHACC varchar(30),
	FOREIGN KEY(MANHACC) REFERENCES NHACC(MANHACC),
	MANV varchar(30),
	FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)
);
CREATE TABLE PHIEUXUAT
(
	MAPX varchar(30) PRIMARY KEY,
	NGAYXUAT date NOT NULL,
	MANV varchar(30),
	FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV),
	MAKH varchar(30),
	FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH)
);

CREATE TABLE CHITIETPHIEUNHAP
(
	MAPN varchar(30),
	MATHUOC varchar(30),

	PRIMARY KEY (MAPN,MATHUOC),
	FOREIGN KEY (MAPN) REFERENCES PHIEUNHAP(MAPN),
	FOREIGN KEY (MATHUOC) REFERENCES THUOC(MATHUOC),

	DONGIA float NOT NULL,
	SOLUONG int NOT NULL,
	
);

CREATE TABLE CHITIETPHIEUXUAT
(
	MAPX varchar(30),
	MATHUOC varchar(30),

	PRIMARY KEY(MAPX,MATHUOC),
	FOREIGN KEY (MAPX) REFERENCES PHIEUXUAT(MAPX),
	FOREIGN KEY (MATHUOC) REFERENCES THUOC(MATHUOC),

	DONGIA float NOT NULL,
	SOLUONG int NOT NULL
);

--5. Sử dụng ngôn ngữ SQL tạo 5 ràng buộc bất kỳ (không tính ràng buộc khóa chính, khóa ngoại)

--1. Thêm thuộc tính SOCHINHANH có kiểu dữ liệu varchar(30) cho quan hệ NHACC
ALTER TABLE NHACC 
ADD SOCHINHANH varchar(30);

--2. Sửa kiểu dữ liệu thuộc tính SOCHINHANH trong quan hệ NHACUNGCAP thành int
ALTER TABLE NHACC 
ALTER COLUMN SOCHINHANH int;

--3. Xóa thuộc tính SOCHINHANH trong quan hệ NHACC
ALTER TABLE NHACC 
DROP COLUMN SOCHINHANH;

--4. DONGIA của quan hệ CHITIETPHIEUNHAP và CHITIETPHIEUXUAT phải từ 1000 đồng trở lên
ALTER TABLE CHITIETPHIEUNHAP 
ADD CONSTRAINT KT_GIAPN CHECK(DONGIA >= 1000);


ALTER TABLE CHITIETPHIEUXUAT 
ADD CONSTRAINT KT_GIAPX CHECK(DONGIA >= 1000);

--5. QUOCGIA trong quan hệ HANGSX là: Anh, Phap, My. Nếu giá trị này không nhập thì giá trị của QUOCGIA là VietNam
ALTER TABLE HANGSX 
ADD CONSTRAINT KT_QG CHECK( QUOCGIA IN ('Anh','Phap','My'));


ALTER TABLE HANGSX 
ADD CONSTRAINT DF_QG DEFAULT 'VietNam' FOR QUOCGIA;

--6. Sử dụng ngôn ngữ SQL nhập liệu cho các bảng. Mỗi bảng ít nhất 5 dòng.

INSERT INTO HANGSX(MAHANGSX,QUOCGIA,TENHANG) VALUES
('H1','My','A'),
('H2','Anh','D'),
('H3','My','F'),
('H4','Phap','E'),
('H5','Anh','C');


INSERT INTO LOAITHUOC(MALOAI,GHICHU,TENLOAI) VALUES
('L1','THUOC A','A1'),
('L2','THUOC B','B0'),
('L3','THUOC A','A7'),
('L4','THUOC B','B3'),
('L5','THUOC A','A5');


INSERT INTO NHACC(MANHACC,TENNHACC,DIACHI,TT_DAIDIEN) VALUES
('NCC1','AB','LE HONG PHONG 10','TEN, DIA CHI, SO DIEN THOAI, NGAY SAN XUAT, HAN SU DUNG'),
('NCC2','BC','CONG VIEN 3/2','TEN, DIA CHI, SO DIEN THOAI, NGAY SAN XUAT, HAN SU DUNG'),
('NCC3','ABC','NGUYEN VAN CU QUAN 1','TEN, DIA CHI, SO DIEN THOAI, NGAY SAN XUAT, HAN SU DUNG'),
('NCC4','CD','NGUYEN VAN CU 5','TEN, DIA CHI, SO DIEN THOAI, NGAY SAN XUAT, HAN SU DUNG'),
('NCC5','CEF','NGUYEN THI MINH KHAI','TEN, DIA CHI, SO DIEN THOAI, NGAY SAN XUAT, HAN SU DUNG');



INSERT INTO THUOC(MATHUOC,TENTHUOC,CONGDUNG,GHICHU,MAHANGSX,MALOAI,MANHACC) VALUES
('T1','DD1','TRI DAU DAU','CHI DINH CUA BS','H1','L1','NCC2'),
('T2','DT2','TRI DAU TAI','CO THE BAN O CAC QUAY THUOC','H1','L2','NCC5'),
('T3','F3','TRI DAU MAT','CO THE BAN O CAC QUAY THUOC','H5','L4','NCC1'),
('T4','F5','TRI DAU KHOP NHE KTDP','CHI DINH CUA BS','H3','L5','NCC3'),
('T6','F5','TRI DAU KHOP LL CAO','CHI DINH CUA BS','H4','L5','NCC3'),
('T5','F5','TRI DAU BUNG','CO THE BAN O CAC QUAY THUOC','H2','L3','NCC4');



INSERT INTO NHANVIEN(MANV,NGAYSINH,HOTEN,SDT) VALUES
('NV1','2000/12/02','NGUYEN VAN ANH','0968743544'),
('NV2','1999/04/15','LE THI BINH','043343544'),
('NV3','1997/11/26','NGUYEN MINH TU','0765463544'),
('NV4','2001/08/12','NHAT ANH LUU','0147643544'),
('NV5','2000/05/22','TUAN QUOC','0968783544');


INSERT INTO KHACHHANG(MAKH,TENKH,SDT,DIACHI) VALUES
('KH1','TRANG PHUONG NGUYEN','0987634576','3/2'),
('KH2','TRAN NHU BANG','0987635776','NGUYEN TRAI'),
('KH3','LE QC','0987630986','CONG QUYNH'),
('KH4','PHUONG NGI','0987634657','CAO THANG'),
('KH5','PHUONG GIA NGHI','0987634699','AN DUONG VUONG');


INSERT INTO PHIEUNHAP(MAPN,NGAYNHAP,MANHACC,MANV) VALUES
('PN1','2023/12/23','NCC1','NV1'),
('PN2','2023/05/09','NCC2','NV2'),
('PN3','2023/03/10','NCC4','NV5'),
('PN4','2022/12/12','NCC3','NV3'),
('PN5','2022/09/25','NCC3','NV3'),
('PN6','2023/06/22','NCC3','NV3'),
('PN7','2023/06/22','NCC5','NV4');


INSERT INTO CHITIETPHIEUNHAP(MAPN,MATHUOC,DONGIA,SOLUONG) VALUES
('PN1','T1','50000.100','100'),
('PN2','T3','55000.100','200'),
('PN3','T2','75000.100','800'),
('PN3','T4','10000.100','300'),
('PN6','T5','75000.100','500'),
('PN4','T4','50000.100','600'),
('PN5','T4','15000.100','700'),
('PN6','T4','12000.100','900'),
('PN7','T5','25000.100','1000');


INSERT INTO PHIEUXUAT(MAPX,NGAYXUAT,MANV,MAKH) VALUES
('PX1','2023/03/1','NV1','KH4'),
('PX2','2022/10/22','NV2','KH1'),
('PX3','2023/10/31','NV3','KH5'),
('PX4','2020/03/01','NV4','KH3'),
('PX5','2023/03/11','NV5','KH1'),
('PX6','2023/03/12','NV5','KH2'),
('PX7','2023/03/10','NV5','KH3');


INSERT INTO CHITIETPHIEUXUAT(MAPX,MATHUOC,DONGIA,SOLUONG) VALUES
('PX1','T1','10000','200'),
('PX1','T5','15000','500'),
('PX3','T4','20000','700'),
('PX4','T3','25000','80'),
('PX5','T3','25000','80'),
('PX6','T3','25000','80'),
('PX7','T3','99000','900'),
('PX3','T3','95000','850'),
('PX3','T2','90000','500');

--Sử dụng ngôn ngữ SQL thực hiện 5 truy vấn.
--Trong đó 2 truy vấn cơ bản, 3 truy vấn phức tạp. Các câu truy vấn không được trùng ý với nhau.

-- 1. Hiển thị mã thuốc, tên thuốc, công dụng của thuốc có tên bắt đầu bằng chữ 'D'.
SELECT MATHUOC, TENTHUOC, CONGDUNG 
FROM THUOC 
WHERE TENTHUOC LIKE 'D%';



--2. Hiển thị danh sách thông tin phiếu nhập có đơn giá cao nhất trong chi tiết phiếu nhập
SELECT * 
FROM CHITIETPHIEUNHAP 
WHERE DONGIA = (
				 SELECT MAX(DONGIA) 
				 FROM CHITIETPHIEUNHAP);

--3. Viết câu truy vấn để hiển thị thông tin gồm mã nhân viên, họ tên, ngày sinh của nhân viên đã thực hiện 3 phiếu xuất .

SELECT MANV,HOTEN,NGAYSINH
FROM NHANVIEN
WHERE MANV IN (
				SELECT MANV
				FROM PHIEUXUAT
				GROUP BY MANV
				HAVING COUNT(*) =3);
--4. Hiển thị thông tin mã phiếu nhập, ngày nhập, mã thuốc, đơn giá được nhập trong tháng 6 năm 2023 và có đơn giá lớn hơn 50000

SELECT pn.MAPN, pn.NGAYNHAP,ct.MATHUOC,ct.DONGIA
FROM PHIEUNHAP pn
JOIN CHITIETPHIEUNHAP ct ON ct.MAPN=pn.MAPN
WHERE MONTH(pn.NGAYNHAP) = 6 AND YEAR(pn.NGAYNHAP) = 2023 AND ct.DONGIA > 50000;

--5. Cho biết mã nhà cung cấp, mã thuốc, tên thuốc, công dụng của thuốc có tên là 'F5', sắp xếp giảm dần theo mã thuốc
SELECT  *
FROM (
		SELECT THUOC.MATHUOC, THUOC.TENTHUOC, THUOC.CONGDUNG, NHACC.MANHACC, NHACC.TENNHACC, NHACC.DIACHI
		FROM NHACC
		JOIN THUOC ON THUOC.MANHACC=NHACC.MANHACC)
AS T
WHERE TENTHUOC='F5'
ORDER BY MATHUOC DESC;


